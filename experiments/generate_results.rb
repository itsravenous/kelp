require "./session_generator.rb"
require "mongo"
require 'pry'

client = Mongo::MongoClient.new
db     = client["ouroboros"]

session_generator = SessionGenerator.new(30)

total = db["kelp_classifications"].find({"user_id" => {"$exists" => true}}).count

db["kelp_classifications"].find({"user_id" => {"$exists" => true}}).each_with_index do |classification, index|
  puts "done #{index} of #{total}" if index%10000 == 0
  session_generator.add(classification["user_id"].to_s || classification["user_ip"], classification)
end

# user_id, classification_count, user_goals, user_goals, user_goals_split, user_goals_splitcode, no_sessions,OptOut, user_goal_on_last_session, classifications_on_last_session, no_classifications_in_sesssion_1,no_classifications_in_sesssion_2,no_classifications_in_sesssion_3,no_classifications_in_sesssion_4,no_classifications_in_sesssion_5,no_classifications_in_sesssion_6,no_classifications_in_sesssion_7,no_classifications_in_sesssion_8,no_classifications_in_sesssion_9,no_classifications_in_sesssion_10,no_classifications_in_sesssion_11,no_classifications_in_sesssion_12,no_classifications_in_sesssion_13,no_classifications_in_sesssion_14,no_classifications_in_sesssion_15,no_classifications_in_sesssion_16,no_classifications_in_sesssion_17,no_classifications_in_sesssion_18,no_classifications_in_sesssion_19,no_classifications_in_sesssion_20,no_classifications_in_sesssion_21,no_classifications_in_sesssion_22,no_classifications_in_sesssion_23,no_classifications_in_sesssion_24,no_classifications_in_sesssion_25,no_classifications_in_sesssion_26,no_classifications_in_sesssion_27,no_classifications_in_sesssion_28,no_classifications_in_sesssion_29,no_classifications_in_sesssion_30,no_classifications_in_sesssion_31,no_classifications_in_sesssion_32,no_classifications_in_sesssion_33,no_classifications_in_sesssion_34,no_classifications_in_sesssion_35,no_classifications_in_sesssion_36,no_classifications_in_sesssion_37,no_classifications_in_sesssion_38,no_classifications_in_sesssion_39,no_classifications_in_sesssion_40,no_classifications_in_sesssion_41,no_classifications_in_sesssion_42,no_classifications_in_sesssion_43,no_classifications_in_sesssion_44,no_classifications_in_sesssion_45,no_classifications_in_sesssion_46,no_classifications_in_sesssion_47,no_classifications_in_sesssion_48,no_classifications_in_sesssion_49,no_classifications_in_sesssion_50,no_classifications_in_sesssion_51,no_classifications_in_sesssion_52,no_classifications_in_sesssion_53,no_classifications_in_sesssion_54,no_classifications_in_sesssion_55,no_classifications_in_sesssion_56,no_classifications_in_sesssion_57,no_classifications_in_sesssion_58,no_classifications_in_sesssion_59,no_classifications_in_sesssion_60,no_classifications_in_sesssion_61,no_classifications_in_sesssion_62,no_classifications_in_sesssion_63,no_classifications_in_sesssion_64,no_classifications_in_sesssion_65,no_classifications_in_sesssion_66,no_classifications_in_sesssion_67,no_classifications_in_sesssion_68,no_classifications_in_sesssion_69,no_classifications_in_sesssion_70,no_classifications_in_sesssion_71,no_classifications_in_sesssion_72,no_classifications_in_sesssion_73,no_classifications_in_sesssion_74,no_classifications_in_sesssion_75,no_classifications_in_sesssion_76,no_classifications_in_sesssion_77,no_classifications_in_sesssion_78,no_classifications_in_sesssion_79,no_classifications_in_sesssion_80,no_classifications_in_sesssion_81,no_classifications_in_sesssion_82,no_classifications_in_sesssion_83,no_classifications_in_sesssion_84,no_classifications_in_sesssion_85,no_classifications_in_sesssion_86,no_classifications_in_sesssion_87,no_classifications_in_sesssion_88,no_classifications_in_sesssion_89,no_classifications_in_sesssion_90,no_classifications_in_sesssion_91,no_classifications_in_sesssion_92,no_classifications_in_sesssion_93,no_classifications_in_sesssion_94,no_classifications_in_sesssion_95,no_classifications_in_sesssion_96,no_classifications_in_sesssion_97,no_classifications_in_sesssion_98,no_classifications_in_sesssion_99,no_classifications_in_sesssion_100,no_classifications_in_sesssion_101,no_classifications_in_sesssion_102,no_classifications_in_sesssion_103,no_classifications_in_sesssion_104,no_classifications_in_sesssion_105,no_classifications_in_sesssion_106,no_classifications_in_sesssion_107,no_classifications_in_sesssion_108,no_classifications_in_sesssion_109,no_classifications_in_sesssion_110,no_classifications_in_sesssion_111,no_classifications_in_sesssion_112,no_classifications_in_sesssion_113,no_classifications_in_sesssion_114,no_classifications_in_sesssion_115,no_classifications_in_sesssion_116,no_classifications_in_sesssion_117,no_classifications_in_sesssion_118,no_classifications_in_sesssion_119,no_classifications_in_sesssion_120,no_classifications_in_sesssion_121,no_classifications_in_sesssion_122,no_classifications_in_sesssion_123,no_classifications_in_sesssion_124,no_classifications_in_sesssion_125,no_classifications_in_sesssion_126,no_classifications_in_sesssion_127,no_classifications_in_sesssion_128,no_classifications_in_sesssion_129,no_classifications_in_sesssion_130,no_classifications_in_sesssion_131,no_classifications_in_sesssion_132,no_classifications_in_sesssion_133,no_classifications_in_sesssion_134,no_classifications_in_sesssion_135,no_classifications_in_sesssion_136,no_classifications_in_sesssion_137,no_classifications_in_sesssion_138,no_classifications_in_sesssion_139,no_classifications_in_sesssion_140,no_classifications_in_sesssion_141,no_classifications_in_sesssion_142,no_classifications_in_sesssion_143,no_classifications_in_sesssion_144,no_classifications_in_sesssion_145,no_classifications_in_sesssion_146,no_classifications_in_sesssion_147,no_classifications_in_sesssion_148,no_classifications_in_sesssion_149,no_classifications_in_sesssion_150,no_classifications_in_sesssion_151,no_classifications_in_sesssion_152,no_classifications_in_sesssion_153,no_classifications_in_sesssion_154,no_classifications_in_sesssion_155,no_classifications_in_sesssion_156,no_classifications_in_sesssion_157,no_classifications_in_sesssion_158,no_classifications_in_sesssion_159,no_classifications_in_sesssion_160,no_classifications_in_sesssion_161,no_classifications_in_sesssion_162,no_classifications_in_sesssion_163,no_classifications_in_sesssion_164,no_classifications_in_sesssion_165,no_classifications_in_sesssion_166,no_classifications_in_sesssion_167,no_classifications_in_sesssion_168,no_classifications_in_sesssion_169,no_classifications_in_sesssion_170,no_classifications_in_sesssion_171,no_classifications_in_sesssion_172,no_classifications_in_sesssion_173,no_classifications_in_sesssion_174,no_classifications_in_sesssion_175,no_classifications_in_sesssion_176,no_classifications_in_sesssion_177,no_classifications_in_sesssion_178,no_classifications_in_sesssion_179,no_classifications_in_sesssion_180,no_classifications_in_sesssion_181,no_classifications_in_sesssion_182,no_classifications_in_sesssion_183,no_classifications_in_sesssion_184,no_classifications_in_sesssion_185,no_classifications_in_sesssion_186,no_classifications_in_sesssion_187,no_classifications_in_sesssion_188,no_classifications_in_sesssion_189,no_classifications_in_sesssion_190,no_classifications_in_sesssion_191,no_classifications_in_sesssion_192,no_classifications_in_sesssion_193,no_classifications_in_sesssion_194,no_classifications_in_sesssion_195,no_classifications_in_sesssion_196,no_classifications_in_sesssion_197,no_classifications_in_sesssion_198,no_classifications_in_sesssion_199,no_classifications_in_sesssion_200,no_classifications_in_sesssion_201,no_classifications_in_sesssion_202,no_classifications_in_sesssion_203,no_classifications_in_sesssion_204,no_classifications_in_sesssion_205,no_classifications_in_sesssion_206,no_classifications_in_sesssion_207,no_classifications_in_sesssion_208,no_classifications_in_sesssion_209,no_classifications_in_sesssion_210,no_classifications_in_sesssion_211,no_classifications_in_sesssion_212,no_classifications_in_sesssion_213,no_classifications_in_sesssion_214,no_classifications_in_sesssion_215,no_classifications_in_sesssion_216,no_classifications_in_sesssion_217,no_classifications_in_sesssion_218,no_classifications_in_sesssion_219,no_classifications_in_sesssion_220,no_classifications_in_sesssion_221,no_classifications_in_sesssion_222,no_classifications_in_sesssion_223,no_classifications_in_sesssion_224,no_classifications_in_sesssion_225,no_classifications_in_sesssion_226,no_classifications_in_sesssion_227,no_classifications_in_sesssion_228,no_classifications_in_sesssion_229,no_classifications_in_sesssion_230,no_classifications_in_sesssion_231,no_classifications_in_sesssion_232,no_classifications_in_sesssion_233,no_classifications_in_sesssion_234,no_classifications_in_sesssion_235,no_classifications_in_sesssion_236,no_classifications_in_sesssion_237,no_classifications_in_sesssion_238,no_classifications_in_sesssion_239,no_classifications_in_sesssion_240,no_classifications_in_sesssion_241,no_classifications_in_sesssion_242,no_classifications_in_sesssion_243,no_classifications_in_sesssion_244,no_classifications_in_sesssion_245,no_classifications_in_sesssion_246,no_classifications_in_sesssion_247,no_classifications_in_sesssion_248,no_classifications_in_sesssion_249,no_classifications_in_sesssion_250,no_classifications_in_sesssion_251,no_classifications_in_sesssion_252,no_classifications_in_sesssion_253,no_classifications_in_sesssion_254,no_classifications_in_sesssion_255,no_classifications_in_sesssion_256,no_classifications_in_sesssion_257,no_classifications_in_sesssion_258,no_classifications_in_sesssion_259,no_classifications_in_sesssion_260,no_classifications_in_sesssion_261,no_classifications_in_sesssion_262,no_classifications_in_sesssion_263,no_classifications_in_sesssion_264,no_classifications_in_sesssion_265,no_classifications_in_sesssion_266,no_classifications_in_sesssion_267,no_classifications_in_sesssion_268,no_classifications_in_sesssion_269,no_classifications_in_sesssion_270

sessions = session_generator.calc_splits()
max_sessions = [100, sessions.collect{|u,sessions| sessions.length}.max].max


File.open("anchoring_experiment.csv", "w") do |f|
  f.puts  ["user_id", "classification_count", "user_goals", "user_goals_split", "no_sessions", "user_goal_on_last_session" ,  "classifications_on_last_session", max_sessions.times.collect{|t| "no_classifications_in_session_#{t}"}].flatten.join(", ")
  db["kelp_users"].find.each do |user|

      prefs = (user["preferences"] || {kelp:{}})["kelp"] || {}
      project_stats = user["projects"]["536d226d3ae740fd20000001"]

      classify_count = prefs["last_session_count"] || 0
      goal           = prefs["goal"] || 0


      user_id = user["_id"].to_s
      next unless sessions[user_id]
      user_goals = project_stats["splits"]["user_goals"]
      user_goals_split  = project_stats["splits"]["user_goals_split"]
      user_goals_splitcode = 0
      opt_out   = opt_out

      no_sessions = sessions[user_id].count
      user_goal_on_last_session = classify_count.to_i + goal.to_i
      classifications_on_last_session = classify_count# sessions[user_id].last["classification_count"]
      classification_count =  sessions[user_id].inject(0){|total, session| total+=session[:classification_count]; total}
      f.puts [ user_id, classification_count, user_goals, user_goals_split, no_sessions, user_goal_on_last_session, classifications_on_last_session, max_sessions.times.collect{|t| (sessions[user_id][t] || {classification_count: 0})[:classification_count] }  ].flatten.join(", ")
  end
end
